{%- layout none -%}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contracts - Saloni Furniture</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-primary: #BCCF11;
      --brand-dark: #8A990C;
      --text-main: #1a1a1a;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #f5f5f5; color: var(--text-main); }
    
    .header {
      background: #000;
      color: #fff;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header-buttons { display: flex; gap: 15px; align-items: center; }
    .header a.btn-back {
      color: #fff;
      background: transparent;
      border: 2px solid #555;
      text-decoration: none;
      font-weight: 600;
      padding: 12px 25px;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .header a.btn-back:hover {
      border-color: #fff;
      background: rgba(255,255,255,0.1);
    }
    .header a.btn-new { 
      color: #000; 
      background: var(--brand-primary);
      text-decoration: none; 
      font-weight: 600;
      padding: 12px 25px;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .header a.btn-new:hover {
      background: #d4e834;
      transform: translateY(-2px);
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .stat-card {
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .stat-card h3 { font-size: 12px; color: #999; text-transform: uppercase; margin-bottom: 10px; }
    .stat-card .value { font-size: 32px; font-weight: 700; }
    .stat-card .value.primary { color: var(--brand-primary); }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--brand-primary);
      display: inline-block;
    }
    
    .contracts-grid { display: grid; gap: 15px; min-height: 200px; }
    
    .contract-card {
      background: #fff;
      border-radius: 15px;
      padding: 20px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .contract-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .contract-link {
      display: flex;
      align-items: center;
      flex: 1;
      text-decoration: none;
      color: inherit;
      cursor: pointer;
    }
    
    .contract-info { flex: 1; }
    .contract-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; }
    .contract-meta { font-size: 13px; color: #666; }
    .contract-meta span { margin-right: 15px; }
    
    .contract-amount { font-size: 20px; font-weight: 700; margin-right: 20px; }
    
    .status-badge {
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      margin-right: 15px;
    }
    .status-saved, .status-kaydedildi { background: #fff3cd; color: #856404; }
    .status-approved, .status-onaylandi, .status-onaylandı { background: #d4edda; color: #155724; }
    
    .delete-btn {
      background: #ff4444;
      color: #fff;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      opacity: 0.7;
    }
    .delete-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    .delete-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .leaderboard {
      background: #fff;
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #eee;
    }
    .leaderboard-item:last-child { border-bottom: none; }
    .leaderboard-rank {
      width: 40px;
      height: 40px;
      background: var(--brand-primary);
      color: #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-right: 15px;
    }
    .leaderboard-name { flex: 1; font-weight: 600; }
    .leaderboard-stats { text-align: right; }
    .leaderboard-count { font-size: 13px; color: #666; }
    .leaderboard-total { font-size: 18px; font-weight: 700; color: var(--brand-dark); }
    
    .empty-state { text-align: center; padding: 50px; color: #999; }
    .empty-state h3 { margin-bottom: 10px; }
    
    .filters { display: flex; gap: 10px; margin-bottom: 20px; }
    .filter-btn {
      padding: 10px 20px;
      border: 2px solid #ddd;
      background: #fff;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--brand-primary);
      background: var(--brand-primary);
      color: #000;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #eee;
      border-top-color: var(--brand-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loading-text {
      margin-top: 15px;
      color: #999;
      font-size: 14px;
      font-weight: 500;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .delete-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .delete-overlay.show {
      display: flex;
    }
    .delete-modal {
      background: #fff;
      padding: 30px 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
    }
    .delete-modal h3 {
      margin-bottom: 15px;
      font-size: 18px;
    }
    .delete-modal p {
      color: #666;
      margin-bottom: 25px;
    }
    .delete-modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .delete-modal-btn {
      padding: 12px 30px;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .delete-modal-btn.cancel {
      background: #eee;
      color: #333;
    }
    .delete-modal-btn.confirm {
      background: #ff4444;
      color: #fff;
    }
    .delete-modal-btn:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>

<div class="delete-overlay" id="delete-overlay">
  <div class="delete-modal">
    <h3>Delete Contract?</h3>
    <p>Are you sure you want to delete this contract? This action cannot be undone.</p>
    <div class="delete-modal-buttons">
      <button class="delete-modal-btn cancel" onclick="closeDeleteModal()">Cancel</button>
      <button class="delete-modal-btn confirm" id="confirm-delete-btn">Delete</button>
    </div>
  </div>
</div>

<div class="header">
  <h1>CONTRACTS</h1>
  <div class="header-buttons">
    <a href="/cart" class="btn-back">← Back to Cart</a>
    <a href="/cart?view=contract&from=contracts" class="btn-new">+ New Contract</a>
  </div>
</div>

<div class="container">
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Contracts</h3>
      <div class="value" id="stat-total">-</div>
    </div>
    <div class="stat-card">
      <h3>Approved</h3>
      <div class="value primary" id="stat-approved">-</div>
    </div>
    <div class="stat-card">
      <h3>Pending</h3>
      <div class="value" id="stat-pending">-</div>
    </div>
    <div class="stat-card">
      <h3>Total Revenue</h3>
      <div class="value primary" id="stat-revenue">-</div>
    </div>
  </div>
  
  <div class="filters">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="saved">Saved</button>
    <button class="filter-btn" data-filter="approved">Approved</button>
  </div>
  
  <h2 class="section-title">Recent Contracts</h2>
  
  <div class="contracts-grid" id="contracts-list">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading contracts...</div>
    </div>
  </div>
  
  <div class="leaderboard">
    <h2 class="section-title">Sales Leaderboard</h2>
    <div id="leaderboard-list">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading leaderboard...</div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  var API_URL = "https://script.google.com/macros/s/AKfycbyq1fZg1aXzKeSu_aDe0n1GrIC6x1PuaDvv2yhdioUMnAnx9ZbJLpuh7GUPiOZKvKhbMA/exec";
  var allContracts = [];
  var currentFilter = "all";
  var deleteTargetId = null;
  
  function formatMoney(amount) {
    var num = parseFloat(amount) || 0;
    return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " USD";
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return "-";
    var d = new Date(dateStr);
    if (isNaN(d.getTime())) return "-";
    return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
  }
  
  function normalizeStatus(status) {
    if (!status) return "saved";
    var s = status.toLowerCase();
    if (s === "kaydedildi" || s === "saved") return "saved";
    if (s === "onaylandi" || s === "onaylandı" || s === "approved") return "approved";
    return s;
  }
  
  function showDeleteModal(contractId, event) {
    event.preventDefault();
    event.stopPropagation();
    deleteTargetId = contractId;
    document.getElementById("delete-overlay").classList.add("show");
  }
  
  window.showDeleteModal = showDeleteModal;
  
  window.closeDeleteModal = function() {
    document.getElementById("delete-overlay").classList.remove("show");
    deleteTargetId = null;
  };
  
  document.getElementById("confirm-delete-btn").onclick = function() {
    if (!deleteTargetId) return;
    
    var btn = this;
    btn.innerHTML = "Deleting...";
    btn.disabled = true;
    
    console.log("Deleting contract:", deleteTargetId);
    
    // GET ile delete (daha güvenilir)
    fetch(API_URL + "?action=delete&id=" + deleteTargetId)
      .then(function(r) { return r.json(); })
      .then(function(result) {
        console.log("Delete result:", result);
        
        if (result.success || result.deleted) {
          // Listeden kaldır
          allContracts = allContracts.filter(function(c) {
            return String(c.id) !== String(deleteTargetId);
          });
          renderContracts(allContracts);
          renderStats(allContracts);
          renderLeaderboard(allContracts);
        } else {
          alert("Delete failed: " + (result.error || "Unknown error"));
        }
        
        closeDeleteModal();
        btn.innerHTML = "Delete";
        btn.disabled = false;
      })
      .catch(function(err) {
        console.error("Delete error:", err);
        alert("Error: " + err.message);
        btn.innerHTML = "Delete";
        btn.disabled = false;
        closeDeleteModal();
      });
  };
  
  function renderContracts(contracts) {
    var list = document.getElementById("contracts-list");
    if (!list) return;
    
    if (!contracts || contracts.length === 0) {
      list.innerHTML = '<div class="empty-state"><h3>No contracts found</h3><p>Create your first contract to get started.</p></div>';
      return;
    }
    
    var filtered = currentFilter === "all" ? contracts : contracts.filter(function(c) {
      return normalizeStatus(c.status) === currentFilter;
    });
    
    if (filtered.length === 0) {
      list.innerHTML = '<div class="empty-state"><h3>No ' + currentFilter + ' contracts</h3></div>';
      return;
    }
    
    var html = filtered.map(function(c) {
      var status = normalizeStatus(c.status);
      var customerName = c.customer_name || c.customer || c.name || "Unknown Customer";
      var salesRep = c.sales_rep || c.salesRep || c.rep || "-";
      var totalAmount = c.total_amount || c.totalAmount || c.total || 0;
      var createdAt = c.created_at || c.createdAt || c.date || "";
      var contractId = c.id || c.ID || "-";
      
      return '<div class="contract-card">' +
        '<a href="/cart?view=contract&id=' + contractId + '&from=contracts" class="contract-link">' +
          '<div class="contract-info">' +
            '<div class="contract-title">' + customerName + '</div>' +
            '<div class="contract-meta">' +
              '<span>' + formatDate(createdAt) + '</span>' +
              '<span>Rep: ' + salesRep + '</span>' +
              '<span>ID: ' + contractId + '</span>' +
            '</div>' +
          '</div>' +
          '<div class="contract-amount">' + formatMoney(totalAmount) + '</div>' +
          '<div class="status-badge status-' + status + '">' + status + '</div>' +
        '</a>' +
        '<button class="delete-btn" onclick="showDeleteModal(\'' + contractId + '\', event)" title="Delete Contract">' +
          '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">' +
            '<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />' +
          '</svg>' +
        '</button>' +
      '</div>';
    }).join("");
    
    list.innerHTML = html;
  }
  
  function renderStats(contracts) {
    var total = contracts.length;
    var approved = contracts.filter(function(c) { return normalizeStatus(c.status) === "approved"; }).length;
    var pending = contracts.filter(function(c) { return normalizeStatus(c.status) === "saved"; }).length;
    var revenue = contracts.filter(function(c) { return normalizeStatus(c.status) === "approved"; }).reduce(function(sum, c) {
      var amount = c.total_amount || c.totalAmount || c.total || 0;
      return sum + (parseFloat(amount) || 0);
    }, 0);
    
    var el1 = document.getElementById("stat-total");
    var el2 = document.getElementById("stat-approved");
    var el3 = document.getElementById("stat-pending");
    var el4 = document.getElementById("stat-revenue");
    
    if(el1) el1.textContent = total;
    if(el2) el2.textContent = approved;
    if(el3) el3.textContent = pending;
    if(el4) el4.textContent = formatMoney(revenue);
  }
  
  function renderLeaderboard(data) {
    var list = document.getElementById("leaderboard-list");
    if (!list) return;
    
    var reps = {};
    var contracts = Array.isArray(data) ? data : (data.leaderboard || data.contracts || []);
    
    contracts.forEach(function(c) {
      if (normalizeStatus(c.status) === "approved") {
        var rep = c.sales_rep || c.salesRep || c.rep || "Unknown";
        if (!reps[rep]) {
          reps[rep] = { name: rep, count: 0, total: 0 };
        }
        reps[rep].count++;
        var amount = c.total_amount || c.totalAmount || c.total || 0;
        reps[rep].total += parseFloat(amount) || 0;
      }
    });
    
    var leaderboard = Object.values(reps).sort(function(a, b) {
      return b.total - a.total;
    });
    
    if (leaderboard.length === 0) {
      list.innerHTML = '<div class="empty-state">No sales data yet</div>';
      return;
    }
    
    var html = leaderboard.map(function(rep, idx) {
      return '<div class="leaderboard-item">' +
        '<div class="leaderboard-rank">' + (idx + 1) + '</div>' +
        '<div class="leaderboard-name">' + rep.name + '</div>' +
        '<div class="leaderboard-stats">' +
          '<div class="leaderboard-count">' + rep.count + ' sales</div>' +
          '<div class="leaderboard-total">' + formatMoney(rep.total) + '</div>' +
        '</div>' +
      '</div>';
    }).join("");
    
    list.innerHTML = html;
  }
  
  function loadData() {
    fetch(API_URL + "?action=list")
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var contracts = Array.isArray(data) ? data : (data.contracts || []);
        allContracts = contracts;
        renderContracts(allContracts);
        renderStats(allContracts);
        renderLeaderboard(allContracts);
      })
      .catch(function(err) {
        console.error("Error:", err);
        var list = document.getElementById("contracts-list");
        if(list) list.innerHTML = '<div class="empty-state"><h3>Error loading contracts</h3><p>Please refresh the page.</p></div>';
      });
  }
  
  window.loadData = loadData;
  
  document.querySelectorAll(".filter-btn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      document.querySelectorAll(".filter-btn").forEach(function(b) { b.classList.remove("active"); });
      btn.classList.add("active");
      currentFilter = btn.getAttribute("data-filter");
      renderContracts(allContracts);
    });
  });
  
  loadData();
})();
</script>

</body>
</html>